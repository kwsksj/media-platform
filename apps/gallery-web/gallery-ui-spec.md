# ギャラリー埋め込みシステム 仕様書

## 目的

Notion（母艦）＋ Cloudflare R2（画像）をソースとして、作品ギャラリーを **Googleサイトに iframe で埋め込み**表示する。表示は白背景（`#FFFFFF`）・時系列（完成日降順）を基本とし、**フィルタは同時に1つのみ**。作品詳細は **モーダル表示**。作品に **★（スター）** を付与でき、**連打可能**。カウントは Cloudflare Worker + KV に保存（Notionには基本的に書き込まない）。

---

## 全体アーキテクチャ

### 配置物

**Cloudflare R2（公開）**

- `gallery.html`：ギャラリーUI本体（単一HTML、CSS/JS内包・フォント埋め込み）
- `gallery.json`：作品データ（`media-platform` の CLI `auto-post` で自動生成してR2へ配置）
- `images/...`：作品画像（既存R2公開URL）

**Cloudflare Workers（任意）**

- `star` API：★カウント取得/更新（KV使用）
  - `data-api-base`（後方互換で `data-star-api`）または `window.API_BASE`（後方互換で `window.STAR_API_BASE`）が未設定なら ★は非表示

**Googleサイト**

- `gallery.html` を iframe 埋め込み（iframe 内スクロール前提）

---

## 機能要件

### 一覧（ギャラリー）

- 初期表示：**完成日 降順**（新しい作品が先頭）
  - 同一完成日の場合：**ID の辞書順（昇順）** で安定ソート
- 表示：カードグリッド
  - 1作品＝1カード
  - 内容：サムネ（1枚）＋作品名＋（任意）完成日＋★カウント
- サムネ規格：**4:5 固定**（Instagram準拠）
  - `aspect-ratio: 4 / 5`
  - `object-fit: cover; object-position: center;`
- ローディング：JSON取得中／★取得中（遅延OK）

### フィルタ（同時に1つのみ）

- 種別：作者 / タグ / 教室（教室は `works[].studio` を使用。Notionの `教室=東京教室` 等から末尾の「教室」を除いた短縮表示 `東京/つくば/沼津` を出力する。会場（浅草橋等）はNotionに保持するが、現状の公開JSONには含めない）
- UI：
  - 3つのセレクトを常時表示（1行目：キーワード、2行目：作者・教室）
  - 値セレクト（候補はデータから動的生成）
  - クリアボタンは設置しない（`すべて` を選択で解除）
- 実装：クライアント側で完結（JSON再取得なし）
- URL表現（推奨）：
  - `?filter=tag&value=どうぶつ`
  - `?filter=author&value=山田`
- 値リストには件数を表示（右寄せ）。**選択後の表示では件数を出さない**。
- フィルタ適用時に `y` 方向のスクロールをリセット

### 詳細（モーダル）

- カードクリックでモーダル表示
- 内容：
  - 作品名
  - 画像一覧（複数・縦並びでOK）
  - キャプション
  - 完成日
  - 作者 / 教室 / タグ（**クリックで一覧にフィルタ遷移**）
  - ★ボタン＋カウント（連打可能）
- 閉じる：**戻るボタン** / 背景クリック / ESC
- モーダルヘッダーは固定表示
- 画像はモーダル本文高さに合わせて最大サイズを自動調整（縦横の制約が強い方を採用）
- 複数画像がある場合は本文末尾に「∨」のスクロールヒントを表示

### ★（スター）

- 作品ごとにカウント保持
- **連打可能**（制限なしで開始）
- 保存先：Cloudflare KV
- 表示：一覧カード・詳細モーダルの双方
- 挙動：
  - 押下即時 +1（オプティミスティック更新）
  - API応答で最終値に補正
  - **連打中の補正**：最新のAPIレスポンス値で上書き（連打中に一時的にカウントが減って見える場合があるが許容）
- API が未設定／到達不能の場合は ★UI を非表示

#### ★機能の設計意図

★は「評価」ではなく「応援アクション」として位置づける。生徒同士の作品に序列をつけるのではなく、気軽に応援を表明できる仕組み。

**運用上の留意点**：

- ★ゼロの作品が並ぶと寂しい印象になりうる
- 必要に応じて初期実装では★表示を省略し、後から有効化することも可

---

## 非機能要件

### 表示速度

- `gallery.json` は初回のみ取得しメモリ保持
- 画像は `loading="lazy"`
- ★取得はまとめて（複数ID一括）

### キャッシュ戦略

- `gallery.json`：`Cache-Control: max-age=300`（5分）
  - 頻繁な更新はないが、更新時に長時間キャッシュが残ると混乱するため短めに設定
  - 将来的にファイル名にタイムスタンプを含める方式への移行も検討可
- `gallery.html`：`Cache-Control: max-age=3600`（1時間）
- 画像：R2デフォルト（長めでOK）

### Googleサイト iframe 制約

- iframe 高さ自動調整なし
- `gallery.html` 側で `height: 100vh; overflow: auto;`
- 背景：白（`#FFFFFF`）
- 外部CDN依存なし（フォント含め単一HTMLに埋め込み）

### エラーハンドリング

| 状況                    | 挙動                                                     |
| ----------------------- | -------------------------------------------------------- |
| `gallery.json` 取得失敗 | 「読み込みに失敗しました。再読み込みしてください」を表示 |
| ★API未設定/到達不能     | ★UI を非表示                                             |
| `images` 配列が空の作品 | 一覧から除外（表示しない）                               |
| 画像読み込み失敗        | プレースホルダー画像を表示                               |

---

## データ仕様（gallery.json）

```json
{
  "version": 1,
  "updated_at": "2026-01-28T00:00:00Z",
  "works": [
    {
      "id": "uuid-or-notion-page-id",
      "title": "作品名",
      "completed_date": "2026-01-20",
      "caption": "任意",
      "author": "任意",
      "studio": "任意",
      "tags": ["任意"],
      "images": [
        "https://<r2-public>/images/.../1.jpg",
        "https://<r2-public>/images/.../2.jpg"
      ],
      "images_light": [
        "https://<r2-public>/images-light/.../1.jpg",
        "https://<r2-public>/images-light/.../2.jpg"
      ],
      "thumb": "https://<r2-public>/thumbs/.../cover.jpg"
    }
  ]
}
```

**必須**：`id`, `title`, `completed_date`, `images`（1枚以上）

**任意**：`caption`, `author`, `studio`, `tags`, `thumb`, `images_light`

`images_light` はモーダル表示用の軽量画像（`images` が高解像度の場合の代替）。未指定時は `images` を使用。

### データ正規化ルール（Notion側で担保）

- **作者名**：Notion の Relation（作者DB）を使用。教室内で使用している呼称（ニックネーム可）。匿名希望の場合は空欄
- **タグ**：Notion の Relation（タグDB）を使用
  - 作品DB上のプロパティ名は「タグ」
  - タグDBのタイトルプロパティ名は「タグ名」
  - 表記揺れを避けるためタグ候補を固定
- **教室**：Notion の `教室`（Select）を正本とし、値は `東京教室/つくば教室/沼津教室` のように「〇〇教室」で統一する。公開JSONの `studio` には表示都合で短縮した `東京/つくば/沼津` を出力する（末尾の「教室」を除去）。会場（浅草橋等）は Notion の `会場`（Select）に保持するが、現状の公開JSONには含めない。

---

## ★ API 仕様（Cloudflare Worker + KV）

### KV Key

- `star:<work_id>` → 数値文字列

### まとめ取得

`GET /stars?ids=<id1>,<id2>,...`

```json
{ "stars": { "<id1>": 12, "<id2>": 0 } }
```

### 加算

`POST /star`

```json
{ "id": "<work_id>", "delta": 1 }
```

```json
{ "id": "<work_id>", "stars": 13 }
```

### CORS

- Allow-Origin: *
- Methods: GET, POST, OPTIONS
- Headers: Content-Type

※ 連打対策は初期なし。必要になったら同一IPの軽いスロットリングを追加。

---

## UI 仕様（gallery.html）

### 構成

- 上部：タイトル＋件数＋フィルタバー
- 本体：カードグリッド（4:5）
- モーダル：詳細

### レスポンシブ

- 幅に応じて 2〜5 列
- 影は薄く、枠線も最小限（作品が主役）
- フィルタはモバイル時は2行、広い画面では1行に並ぶ
- フォント：日本語は Zen Kaku Gothic New、英数は Courier Prime（メトリクス調整版）

---

## media-platform 側の追加（CLI: `auto-post`）

### 新コマンド（例）

- `auto-post export-gallery-json`
  - Notion から必要項目取得
  - `completed_date` 降順でソート（同一日はID昇順）
  - R2 公開URLを `images[]` に整形
  - `gallery.json` 生成 → R2へアップロード
  - サムネ生成はデフォルトで有効（`--no-thumbs` で無効化）
  - オプション：`--output` / `--no-upload` / `--no-thumbs` / `--thumb-width`

### 実行タイミング

- **定期実行**：1日1回（早朝など）
- **イベント駆動**：import/post 完了後に自動追随
- **手動トリガー**：管理者がコマンド実行で即時反映

※ 新作品投稿後すぐにギャラリーで確認したい場合は手動トリガーを使用

---

## サムネ生成（実装済み）

- 一覧用：**4:5 センタークロップ**、幅 600px（`--thumb-width` で変更可）
- 形式：JPEG（品質80目安）
- 保存：`thumbs/<work_id>.jpg`
- UI は `thumb ?? images[0]` で後方互換

---

## 将来拡張メモ

### SEO対応（検索流入を狙う場合）

現在のiframe埋め込み方式ではSEO効果はほぼゼロ。「生徒作品 木彫り」等での検索流入を狙う場合は、独立したサブドメイン（例：`gallery.kawasaki-kibori.com`）での静的サイト化を検討。現設計（単一HTML＋JSON）はその移行も容易。

### 更新停滞対策

長期間更新がない場合にギャラリーが寂しく見える問題への対策案：

- 「今月のピックアップ」枠で過去作品を再掲
- ランダム表示モードの追加

---

## 受け入れ条件

- 完成日降順で表示（同一日はID順で安定）
- フィルタは同時に1条件のみ有効
- 一覧サムネは 4:5 に揃って見える
- モーダルで詳細が確認でき、リンクからフィルタ遷移できる
- ★は連打可能で、リロード後も保持される
- Googleサイト iframe で崩れない
- エラー時に適切なフォールバック表示がされる

---

## 実装優先度（参考）

| 優先度 | 機能                   | 備考                 |
| ------ | ---------------------- | -------------------- |
| P0     | 一覧表示・詳細モーダル | コア機能             |
| P0     | フィルタ               | コア機能             |
| P1     | gallery.json 自動生成  | 運用に必須           |
| P2     | ★機能                  | 実装済み             |
| P3     | サムネ生成             | 実装済み             |

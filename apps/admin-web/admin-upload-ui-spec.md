# 先生専用アップロードUI 仕様書（v1.4.1）

## 目的

スマホ（Googleフォトで編集済みの画像）から、作品情報（作者・作品名・タグ等）を最小操作で確定し、画像をR2へ保存しつつ、Notion「生徒作品」DBにレコード作成までを一気通貫で行う。

加えて、既にNotionに登録済みの作品（画像はあるが、作品名/作者/タグが未整備）を、画像プレビューを見ながら高速に後付け整備できる「整備モード」を提供する。

さらに、タグDB（親子関係・統合・別名）を改定した後に、既存作品のタグを自動補正（親タグの追加・merged置換など）できる「タグ一括再計算」機能を提供する。

**v1.3で追加**：既存作品の画像セットを分割・統合・移動できる「画像セット操作」機能を提供する。

## データソース前提（現時点）

- 画像ファイルの正本: `Cloudflare R2`
- 作品メタデータ・投稿状態: `Notion`
- 生徒名簿・予約状況の正本: `Google スプレッドシート`

将来的に、生徒名簿・予約系データの移行先として Notion 等を検討中。

## v1.4 変更点（要点）

- **教室/会場値の正規化**：`participants_index.json` の `classroom`（表示名）/`venue`（会場）を、Notion 側の `教室`（Select, 例：`東京教室`）/`会場`（Select）へ **正規化して保存**する（予約UIの短縮表記や表記ゆらぎでDBが汚れないようにする）。
- **「整備済」の意味を固定**：「公開ギャラリーに出してよいメタデータ確定」という意味に統一し、新規登録でもチェックボックスで明示できるようにする（自動判定は初期値にのみ使う）。
- **代表画像（表紙）の指定**：複数画像のうち「ギャラリーの顔」を指定できるようにし、Notion の `画像` 配列順（先頭）で表現する。
- **画像統合のデフォルトを「削除」→「アーカイブ」へ**：統合元ページID（＝★カウントのキー）を温存し、KV側の“孤児★”を増やしにくくする。
- **管理APIの認証**：フロント（admin.html）に固定鍵を埋め込まない。基本は Cloudflare Access のパス保護に寄せ、必要に応じて Worker 側で二重化する。

## スコープ

- 先生（管理者）専用。生徒向け公開機能・認証強化は後回し。
- 予約WebAppからリンクで呼び出す（例：`/upload?date=YYYY-MM-DD`）。独立アプリとして動作してよい。
- サムネ生成は後回し可。UIはCSSの4:5固定（`object-fit: cover`）で規格化。
- 既存データは「Notionに作品レコードはあり、画像も付いている。欠けているのは作品名/作者/タグ等」という前提（R2未登録やNotion未登録は扱わない）。

---

## リポジトリ構成

管理UIは `media-platform` モノレポ内の `apps/admin-web` に配置し、公開UI/Workerは責務別ディレクトリで分離する。

```text
media-platform/
├── apps/gallery-web/
│   └── gallery.html                # 公開ギャラリー（iframe埋め込み用）
├── apps/admin-web/
│   ├── admin.html                  # 管理UI（先生専用）
│   ├── shared/
│   │   ├── gallery-core.js         # 共通ロジック（グリッド、モーダル、フィルタ）
│   │   └── gallery-core.css        # 共通スタイル
│   └── admin/
│       ├── admin.js                # 管理専用（アップロード、整備、Notion操作）
│       └── admin.css               # 管理専用スタイル
└── apps/worker-api/
    ├── worker/src/index.js         # API（★ + 管理系エンドポイント）
    └── wrangler.toml
```

### 共通コンポーネント（shared/）

galleryとadminで共有するUIコンポーネント：

| コンポーネント        | gallery.html | admin.html | 備考                              |
| --------------------- | ------------ | ---------- | --------------------------------- |
| カードグリッド（4:5） | ✓            | ✓          | 一覧表示のベース                  |
| モーダル（画像表示）  | ✓            | ✓          | 複数画像スワイプ/サムネストリップ |
| フィルタUI            | ✓            | ✓          | タグ/作者/教室での絞り込み        |
| タグチップ表示        | ✓            | ✓          | クリックでフィルタ遷移            |
| ★ボタン               | ✓            | ✓（任意）  | 管理UIでは非表示でも可            |

### 管理専用コンポーネント（admin/）

| コンポーネント             | 用途                                       |
| -------------------------- | ------------------------------------------ |
| 画像アップロード           | ファイル選択、EXIF抽出、プレビュー、R2送信 |
| 編集フォーム               | 作品名入力、作者選択、キャプション         |
| タグ入力（タイプアヘッド） | 検索、選択、親子自動付与表示               |
| 画像セット操作             | 分割/統合/移動                             |
| ギャラリー更新トリガー     | GitHub Actions呼び出し                     |

### ビルド

- `gallery.html`：shared/* を埋め込んで**単一HTML化**（Googleサイトiframe制約のため外部依存不可）
- `admin.html`：shared/*+ admin/* を埋め込んで単一HTML化、またはモジュール分離のまま（Cloudflare Access配下なので制約緩い）

---

## 認証・権限

| UI            | 認証方式          | 備考                               |
| ------------- | ----------------- | ---------------------------------- |
| gallery.html  | なし              | 公開、iframe埋め込み               |
| admin.html    | Cloudflare Access | 先生のメールアドレスでアクセス制御 |
| Worker管理API | Bearer Token      | admin.htmlからの呼び出し用         |

admin.html と Worker を同一ドメインに配置し、Cloudflare Access の Cookie をファーストパーティとして扱えるようにする（3rd-party cookie制限回避）。

---

## 将来拡張：生徒向けUI

生徒自身が作業工程の写真をアップロードできるUIを将来追加する想定。

### 想定機能

- 自分の作品一覧を表示（作者でフィルタ済み）
- 作品を選択し、工程写真を追加アップロード
- 作品名・タグの編集は不可（先生が管理）

### UI構成（案）

```text
apps/admin-web/
├── ...
├── student.html              # 生徒UI（将来追加）
└── student/
    ├── student.js            # 生徒専用ロジック
    └── student.css
```

### 認証（検討中）

- 予約システム（GAS）との連携でログイン
- または、Cloudflare Access で生徒メールアドレスを許可
- `student_id` に紐づく作品のみ操作可能にする権限制御が必要

### 共通化のポイント

- shared/ のコンポーネントはそのまま利用
- admin/ の画像アップロード部分を流用（Notion書き込み先を「工程写真」プロパティに変更）
- 編集フォームは不要または簡略版

---

## 前提データ（Notion DB）

### タグDB（正本）

タグは「タグDB（Relation）」を正本とする。

最低限必要なプロパティ（名称は多少変わっても良いが意味は維持する）：

- `タグ`（Title）
- `別名`（Text / Rich text）：カンマ区切り運用（例：`ねこ, ネコ`）
- `状態`（Select）：`active` / `merged` / `hidden`
- `統合先`（Relation → タグDB、1件）：`状態=merged` のとき必須
- `親タグ`（Relation → タグDB）
- `子タグ`（Relation → タグDB）
- `作品`（Relation → 生徒作品DB）
- `作品数`（Formula）：候補並び順に利用

#### 状態（status）の定義

| 状態     | 用途                                             | 一括再計算での扱い                         |
| -------- | ------------------------------------------------ | ------------------------------------------ |
| `active` | 通常使用するタグ                                 | そのまま保持                               |
| `merged` | 廃止され別タグに統合されたタグ                   | `統合先` に自動置換                        |
| `hidden` | 内部管理用・非公開タグ（例：要レビュー、未分類） | 保持するが、タグ入力UIの候補には表示しない |

### 生徒作品DB（抜粋）

- `作品名`（Title）
- `画像`（Files）
- `完成日`（Date）※撮影日を流用
- `教室`（Select）：**正規値（例：東京教室/つくば教室/沼津教室）**で運用（後述）
- `会場`（Select、任意）：例）`浅草橋` / `東池袋` / `つくば` / `沼津`（**現状は公開JSONには出さない**。将来 `studio` 表示へ併記する余地あり）
- `作者`（Relation → 生徒DB）：**Select運用は避ける**（後述）
- `キャプション`（Text）
- `タグ`（Relation → タグDB）
- `整備済`（Checkbox）：**必須**。整備モードのキュー管理に使用（意味は後述）

#### 教室（Select）の正規値（推奨）

- `東京教室` / `つくば教室` / `沼津教室`（必要なら追加するが、まずは増やさない）
- Notion上は基本「〇〇教室」の表記で運用する。一方で、予約アプリ等のUIでは表示都合で「教室」を省いた表記（例：`東京`）が混在し得るため、**保存前に正規化**する。

正規化ルール（例）：

- `classroom` 文字列から末尾の `教室` を取り除いたうえで判定（`東京教室` と `東京` を同一視）
- `東京` を含む → `東京教室`
- `つくば` を含む → `つくば教室`
- `沼津` を含む → `沼津教室`
- 判定不能 → 手動選択（正規値から）

注：UIの表示ラベルは短縮（`東京`）でもよいが、**Notionへ送る値は `東京教室` のような正規値**に統一する。

公開JSON（gallery.json）への出力（現状）：

- `works[].studio` は **教室の短縮表示**（例：`東京`）として出力する（Notionの `教室=東京教室` から「教室」を除いたもの）。
- `会場` を併記した表示（例：`東京（浅草橋）`）は将来拡張の余地として残し、**互換性維持のため既定では出さない**。

会場の扱い：

- `venue` が取れる場合は Notion の `会場`（Select）に保存する（教室Selectは粗く、表示は会場まで細かく、の二層にする）。
- `venue` が Notion の選択肢に存在しない場合は、**保存せず警告**し、手動で選択（または Notion 側で選択肢を追加）する。

#### 作者（Relation）の前提

- 作者は「生徒DB」への Relation を正本とする（作品DBの `作者` を Select にしない）。
- 既存運用が Select の場合は、移行までの暫定として「Select→Relation変換」の移行スクリプト（または人力移行）を別途用意する。UI側で両対応すると、後から整合性が壊れやすいので推奨しない。

#### 「整備済」の意味（v1.4で固定）

- `整備済=true` は **「公開ギャラリーに出してよいメタデータが確定した」** ことを意味する。
- 「作品名・作者・タグが入力されたか」は *参考にはするが、最終判断はUI上のチェックで明示* できるようにする（自動判定は初期値にのみ使用）。

---

## 機能一覧

### A. アップロード（新規登録）

画像選択→EXIFから撮影日抽出→教室自動決定→当日参加者候補から作者選択→タグ入力（親子補助/統合/別名）→R2保存→Notion作品作成。

### B. 整備モード（既存作品の後付け整備）

Notionに既に存在する作品を、画像プレビュー付きで順に開き、作品名・作者・タグを素早く埋める。

### C. タグ一括再計算（タグ改定後の自動補正）

既存作品のタグを、タグDBの親子関係・統合に基づいて補正（親タグ閉包＋merged置換）。dry-runで差分確認→applyで反映。

### D. 画像セット操作（v1.3追加）

既存作品の画像を分割（1作品→複数作品）、統合（複数作品→1作品）、移動（作品A→作品B）する。

### E. ギャラリー更新トリガー（v1.3追加）

アップロード/整備完了後に、公開ギャラリー（gallery.json）の更新をUIからトリガーする。

---

## 画面仕様

### 1) アップロード画面（新規登録）

#### 主要UI

- 画像選択（複数可）
- プレビュー（4:5枠、複数枚の場合はスワイプ/サムネ一覧で全枚確認可能）
- **表紙（代表画像）指定**：複数枚のうち「ギャラリーの顔」を選べる（選んだ画像を `画像` 配列の先頭にする）
- 自動抽出：撮影日（EXIF）・撮影時刻（任意）
- 自動決定：教室（撮影日から一意に決定）
- 作者：当日参加者候補（撮影日から）を提示 → 選択
- 作品名、キャプション
- タグ：タイプアヘッド＋チップ
- 実行：アップロード＆Notion登録

#### 日付・教室

- 画像EXIFの `DateTimeOriginal` から `YYYY-MM-DD` を抽出して `完成日` 候補にセット。
- `participants_index.json` の該当日 `dates[YYYY-MM-DD]` を参照し、開催グループ（`classroom`/`venue`）を取得。
  - グループが **1件**：自動で選択（教室Selectは正規化して保存し、会場は `venue` を保存）
  - グループが **複数件**：`classroom / venue` のプルダウンを表示して選択（「同日複数教室」が将来混ざっても壊れない）
  - グループが **0件（範囲外含む）**：教室（正規値）を手動選択し、必要なら会場も手入力

- 教室Selectは `participants_index.json` の表示名をそのまま入れず、**正規化**して保存する（「東京教室」等が混入しないようにする）。正規化の具体は「前提データ（Notion DB）」参照。

**EXIF日付の扱い**：

- EXIFはカメラのローカル時刻でタイムゾーン情報がないことが多い。原則「撮影日（ローカル＝JST想定）」として `YYYY-MM-DD` を生成する。
- EXIFがない場合は `file.lastModified` から日付推定（精度低）、または手動入力を必須にする。

#### 作者候補

- `完成日`（EXIF撮影日）から `participants_index.json` の該当日エントリを参照。
- 該当日の `participants` を候補として提示。

補足（データ範囲）：

- `participants_index.json` は **過去730日〜未来60日** が主対象。古い作品の整備では一致しないことがあるため、常に「全生徒検索（名簿）」フォールバックを備える。

- フォールバック：該当日にエントリがない場合、または参加者0件の場合は、全生徒検索（名簿）から選択。

---

### 2) 整備モード（既存作品の後付け整備）

#### 目的と思想

CLIでは画像確認ができず、判断コストが上がるため、整備はUIで行う。操作は「次へ次へ」で流れ、入力は必要最低限にする。

#### 対象抽出（未整備の定義）

`整備済` プロパティが **未チェック** の作品を「未整備」とする。

補足：

- `作品名` が空かどうか、仮題かどうかは判定に使用しない。
- 仮題（例：`YYYY-MM-DD（教室）#連番`）を付けた場合でも、`整備済` を明示的にチェックしない限りキューに残る。
- これにより「とりあえず仮題で登録→後で正式名を付ける」ワークフローが可能。

#### 一覧（キュー）画面

- 未整備作品を完成日降順でカード一覧表示（ギャラリー）。
- 1カードに表示する要素：代表画像（4:5）、画像枚数バッジ（2枚以上の場合）、完成日、教室、作者の有無、タグ数、作品名の有無。
- フィルタ：
  - 期間（完成日）
  - 教室
  - 「作者なし」「タグなし」「作品名なし」
  - （任意）特定タグが付いている/付いていない
- 並び：完成日降順（基本）。

#### 編集モーダル（1作品ずつ整備）

カードを開くとモーダルで編集。次/前で連続処理できる。

**画像表示（v1.3強化）**：

- 複数画像がある場合、メイン表示エリア（4:5）＋下部にサムネイルストリップを表示。
- サムネイルをタップでメイン表示を切り替え。
- サムネイルから **「表紙にする」** を選択可能（表紙にした画像を `画像` 配列の先頭に並べ替える）
- スワイプでも切り替え可能。
- 画像枚数と現在位置を表示（例：「2/5」）。

入力/補助：

- 作品名：
  - 手入力
  - 「仮題を付ける」ボタン（例：`YYYY-MM-DD（教室）#連番`）
  - 仮題を付けても `整備済` は自動でONにならない（明示的操作が必要）
- 作者：
  - `participants_index.json` から完成日の参加者候補を提示
  - 候補から選択、もしくは全生徒検索
- タグ：
  - タイプアヘッド（別名吸収/merged統合/親子補助）
  - 子タグ選択で親タグ自動付与（多段）
  - 親タグ選択で子タグをサジェスト（自動付与はしない）
- キャプション：任意（整備対象に含めるかは設定）

操作性（推奨）：

- 「保存して次へ」ボタン（`整備済` を自動でONにして次へ）
- 「保存のみ」ボタン（`整備済` はONにせず保存、キューに残る）
- 「スキップ」ボタン（未保存のまま次へ。後で戻れる）
- 進捗表示（残件数、今日の処理件数など）

保存タイミング：

- 明示的保存（ボタン）を基本。
- オプションで自動保存（フィールド離脱時）も可だが、誤爆が怖いのでv1.3は明示保存推奨。

---

### 3) 画像セット操作（v1.3追加）

#### 目的

撮影時に「1作品に複数画像」としてまとめたが、実は別作品だった場合の分割や、逆に別々に登録したが同一作品だった場合の統合を行う。

#### 操作モード

**a) 分割（1作品 → 複数作品）**

- 対象作品を選択し、画像一覧を表示。
- 分割したい画像を選択（複数選択可）。
- 「新規作品として分割」を実行。
- 選択した画像で新規作品レコードを作成。元作品のプロパティ（作者、教室、完成日、タグ）をコピー。
- 新規作品は `整備済=false` で作成（作品名の確認が必要なため）。

**b) 統合（複数作品 → 1作品）**

- 統合元の作品を複数選択（一覧画面でチェックボックス）。
- 統合先（どの作品に画像をまとめるか）を指定。
- 「統合」を実行。
- 統合元の画像を統合先の `画像` プロパティに追加。
- 統合元の作品レコードは **原則アーカイブ**（Notionの `archived=true` を推奨。削除はしない）。
  - 理由：★カウントのキーが `work_id`（Notion page id）なので、削除するとKV側に“孤児★”が残りやすい。アーカイブならIDは温存され、ギャラリー側からは自然に消える。
- 注意：タグは統合先のものを維持（統合元のタグは自動マージしない。必要なら手動で追加）。

**c) 移動（作品A → 作品B）**

- 移動元の作品を開き、画像一覧を表示。
- 移動したい画像を選択。
- 移動先の作品を検索・選択。
- 「移動」を実行。
- 選択した画像を移動先の `画像` プロパティに追加し、移動元から削除。
- 移動元の画像が0枚になる場合は警告を表示（作品レコードは **削除ではなくアーカイブ** を推奨）。
- 表紙指定（代表画像）は、移動後に必要なら再指定する（`画像` 先頭が表紙扱い）。

#### UI配置

- 整備モードの編集モーダル内に「画像操作」ボタンを配置。
- または、一覧画面に「画像セット操作モード」トグルを設け、複数作品選択→統合の流れを可能にする。

---

### 4) ギャラリー更新トリガー（v1.3追加）

#### 目的

アップロードや整備を行った後、公開ギャラリーへの反映を待たずに即時更新できるようにする。

#### 既存システムとの関係

公開ギャラリーは以下の仕組みで運用されている：

```
[Notion 生徒作品DB]
        ↓
[GitHub Actions: gallery-export.yml]
   - 日次自動実行（16:10 JST）
   - workflow_dispatch で手動実行可
        ↓
[auto-post export-gallery-json]
   - gallery.json 生成
   - サムネイル生成（thumbs/）
   - 軽量画像生成（images-light/）
        ↓
[R2: gallery.json + thumbs/ + images-light/]
        ↓
[gallery.html]
```

アップロードUIからは、この既存フローの `workflow_dispatch` をトリガーする。

#### UI

- 画面上部またはフッターに「ギャラリー更新」ボタンを常時表示。
- 押下時の挙動：
  1. 確認ダイアログ：「ギャラリーを更新しますか？（反映まで1〜2分かかります）」
  2. Worker API を呼び出し
  3. 成功時：「更新をリクエストしました。1〜2分後に反映されます。」
  4. 失敗時：エラーメッセージを表示し再試行可能に
- ボタン横に最終更新日時を表示（`gallery.json` の `updated_at` から取得）。

#### リマインド（任意）

- アップロード完了時または整備モード終了時に、「ギャラリーを更新しますか？」とトースト通知。
- 押下でギャラリー更新、無視で何もしない（日次バッチで反映される）。

#### API（Worker追加エンドポイント）

既存の★API Worker に以下を追加：

**エンドポイント**

```
POST /admin/trigger-gallery-update
// Cloudflare Access で保護（推奨）
// フロント（admin.html）からは固定鍵を送らない

```

補足：CI/CLI などブラウザ外から呼びたい場合は、Worker 側で `Authorization: Bearer <ADMIN_API_KEY>` を **追加で**受け付けてもよい（ただし **admin.html には埋め込まない**）。

**レスポンス**

```json
// 成功
{ "ok": true, "message": "workflow triggered" }

// 失敗
{ "ok": false, "error": "GitHub API error: ..." }
```

**実装概要**

```javascript
async function handleTriggerGalleryUpdate(request, env) {
  // 認証チェック
  // 認証：基本は Cloudflare Access のパス保護で担保する。
  // 追加で二重化したい場合のみ、ここに Bearer 等のチェックを入れる（フロントに固定鍵は埋め込まない）。

  // GitHub API で workflow_dispatch をトリガー
  const response = await fetch(
    `https://api.github.com/repos/${env.GITHUB_REPO}/actions/workflows/gallery-export.yml/dispatches`,
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${env.GITHUB_TOKEN}`,
        "Accept": "application/vnd.github.v3+json",
        "User-Agent": "gallery-admin"
      },
      body: JSON.stringify({ ref: "main" })
    }
  );

  if (response.status === 204) {
    return jsonResponse({ ok: true, message: "workflow triggered" });
  } else {
    const text = await response.text();
    return jsonResponse({ ok: false, error: `GitHub API error: ${text}` }, 500);
  }
}
```

**Worker 環境変数（追加）**

| 変数名          | 説明                                                                    |
| --------------- | ----------------------------------------------------------------------- |
| `ADMIN_API_KEY` | （任意）管理APIを二重化する場合の認証キー。**フロントには埋め込まない** |
| `GITHUB_TOKEN`  | GitHub Personal Access Token（`workflow` スコープ）                     |
| `GITHUB_REPO`   | リポジトリ名（例：`username/media-platform`）                           |

---

## タグ入力仕様（アップロード/整備で共通）

### タグインデックスと鮮度管理

UIの応答性のため、タグ一覧は `tags_index.json` としてR2に配置し、UIはそれをfetchする。

**鮮度管理（v1.3追加）**：

- `tags_index.json` に `generated_at`（生成日時）を含める。
- UI起動時に `generated_at` を確認し、**24時間以上経過**している場合は警告バナーを表示：「タグインデックスが古い可能性があります。最新のタグ構成が反映されていない場合があります。」
- 管理画面に「タグインデックス再生成」ボタンを設置。押下でインデックスを即時再生成。
- 将来拡張：タグDB更新時のwebhookで自動再生成（v1.3ではオプション）。

### 検索（タイプアヘッド）

- UI起動時にタグインデックスを取得し、ローカル検索（1文字目から即候補）。
- 検索対象：`タグ(Title)` と `別名`（カンマ分割）。
- **かな正規化（v1.3追加）**：検索時にひらがな⇔カタカナを同一視する。実装方法として、検索クエリと対象文字列の両方をひらがなに正規化してからマッチング。これにより「ねこ」で「ネコ」もヒットする。
- 候補並び：完全一致 > 前方一致 > 部分一致、同順位は `作品数` 降順。
- `状態=hidden` のタグは候補に表示しない（既に作品に付与されている場合は表示するが、新規選択はできない）。

### 統合（merged）の扱い

- `状態=merged` のタグを選んだ場合、必ず `統合先` を選択結果とする。
- 以後の処理（親展開など）も統合先で行う。

### 子タグ入力 → 親タグ自動付与

- ユーザーが明示的に選んだタグ集合を `explicitTags` とする。
- `explicitTags` の各タグについて親（祖先）を再帰的に収集し `derivedParentTags` を得る。
- `derivedParentTags` はUI上「自動付与（薄色/ロック）」として表示。
- 保存時は `explicitTags ∪ derivedParentTags` を Notion作品の `タグ` に書き込む。
- 注意：循環防止（visited集合）、重複排除（Set）。

### 親タグ入力 → 子タグサジェスト

- 親タグを明示選択した場合、そのタグの `子タグ` をサジェスト枠に表示。
- 自動付与はしない（事故防止）。
- 検索時に「親タグで候補を絞るモード」を持つ場合は、子孫を検索範囲にして良い。

### 新規タグ追加

- マッチしない場合「新規作成」を提示。
- ただし作成前に近似候補を必ず表示（増殖抑止）。近似判定にはかな正規化を適用。
- 作成時：タグDBに `状態=active` の新規ページを作成し、即選択。

---

## 画像取り込み仕様（新規登録で使用）

### 入力

- スマホでGoogleフォト編集済み画像（端末ライブラリ経由で選択→アップロード）。
- 複数画像可（同一作品の複数枚として扱う）。

### 保存

- Cloudflare R2に保存。
- v1.3はオリジナルを保存してよい。
- 拡張ポイント：アップロード時に本体リサイズ（長辺1600）とサムネ生成（4:5幅600）を差し込める設計にする。

---

## Notionへの書き込み

### 新規作品作成

- `作品名`：入力（空なら仮題）
- `画像`：R2 URLをFilesとして登録（**順序を保持**。先頭を表紙扱いとする）
- `完成日`：撮影日
- `教室`：`participants_index.json` のグループ選択により決定（**正規化済み**のSelect値）
- `会場`：`venue` が取れる場合は保存（取れない場合は空で可）
- `作者`：選択された生徒（Relation）
- `キャプション`：入力
- `タグ`：`explicitTags ∪ derivedParentTags`（Relation）
- `整備済`：UIの「整備済として確定」チェックの値を保存する（初期値は「作品名・作者・タグが揃っていればON」を推奨。ただし保存前に手で切り替え可能にする）

### 既存作品更新（整備モード）

- 作品ページのプロパティを部分更新（作品名/作者/タグ/キャプション等）。
- 画像自体は触らない（画像セット操作は別機能）。

### エラーハンドリング（v1.3強化）

#### 新規登録時の部分成功

新規登録は「R2保存 → Notion作成」の2段階で行われる。

| R2保存 | Notion作成 | 対応                                                                                                           |
| ------ | ---------- | -------------------------------------------------------------------------------------------------------------- |
| 成功   | 成功       | 正常完了                                                                                                       |
| 失敗   | -          | UIにエラー表示、再試行可能                                                                                     |
| 成功   | 失敗       | **孤立ファイル発生**。UIに警告表示し、以下の選択肢を提示：(1) Notion作成を再試行、(2) R2ファイルを削除して中止 |

#### 孤立ファイルの管理

- R2に保存したがNotionに登録されなかったファイルは「孤立ファイル」となる。
- 定期バッチ（日次推奨）で、R2ファイルのうちNotionに参照されていないものを検出し、一定期間（7日）経過後に自動削除。
- 管理画面に「孤立ファイル一覧」を表示し、手動削除も可能とする（将来拡張）。

#### 既存作品更新時

- Notion更新失敗時は、UIにエラーを表示し再試行できる。
- 失敗した作品はキューに残り続ける。

---

## 追加要件：タグ一括再計算（タグ改定後の自動補正）

### 目的

タグDBの親子関係や統合（merged）を変更した後、既存の生徒作品のタグを整合状態に自動補正する。

主な補正：

- 子タグが付いている作品に、親タグ（祖先）を追加
- mergedタグが残っている場合、統合先へ置換

### 対象抽出

- 全件
- 期間指定（完成日）
- 特定タグが付いている作品のみ
- 未整備作品のみ（`整備済=false`）

### 処理手順（アルゴリズム）

1) タグインデックスを読み込む（ID、状態、統合先、親子関係）。
2) 作品ページから現在のタグ集合 `T0` を取得。
3) `T0` を正規化：
   - `状態=merged` のタグは `統合先` に置換
   - `状態=hidden` のタグは**保持**（内部管理用タグは維持する）
4) 親タグ閉包：`T1 = T0 ∪ ancestors(T0)`（多段）。循環防止（visited）。
5) 差分：追加 `add = T1 - T0`、削除（merged置換で生じた旧タグ等）を計算。
6) dry-run：対象件数、変更件数、変更例を表示。
7) apply：作品ページの `タグ` Relation を `T1` へ更新。

### 事前チェック（v1.3追加）

実行前に以下の整合性チェックを行い、問題があれば警告を表示して続行確認：

- **循環検出**：親子関係に循環がある場合（A→B→C→Aなど）
- **merged統合先欠落**：`状態=merged` だが `統合先` が空、または統合先が存在しない場合
- **統合先がmerged**：統合先自体が `状態=merged` の場合（多段統合）

### 提供形態

- CLI（auto-postのサブコマンド追加）を基本とする。
- 将来：管理画面としてUIに組み込み、「特定タグだけ試す」などのインタラクティブ操作を可能にする。

### 安全と性能

- Notion APIのページング、レート制限を考慮。
- 途中再開できるカーソル保持。
- 大量件数の場合はバッチ分割（100件ずつ等）。

---

## 依存データ／API（実装接点）

### タグインデックス

`tags_index.json` を定期生成してR2に配置し、UIはそれをfetchする。

JSONに含める内容：

```json
{
  "generated_at": "2024-01-15T10:30:00Z",
  "tags": [
    {
      "id": "notion-page-id",
      "name": "動物",
      "aliases": ["どうぶつ", "アニマル"],
      "status": "active",
      "merge_to": null,
      "parents": ["parent-id-1"],
      "children": ["child-id-1", "child-id-2"],
      "usage_count": 42
    }
  ]
}
```

### 当日参加者候補（participants_index.json）

参加者候補は、予約システム（GAS）が生成する `participants_index.json` から取得する。

**取得方法**

- UI起動時に `GET /participants-index` を1回だけfetchしてメモリに保持
- 認証は Cloudflare Access（ブラウザログイン）で行う
- UIコード内にトークン等の秘匿情報は持たない

**JSON構造**

```json
{
  "generated_at": "2026-02-04T12:34:56+09:00",
  "timezone": "Asia/Tokyo",
  "source": { "reservations_cache_version": 1738640000000 },
  "dates": {
    "2026-02-02": [
      {
        "lesson_id": "LESSON_UUID",
        "classroom": "東京教室",
        "venue": "浅草橋",
        "participants": [
          { "student_id": "user_xxx", "display_name": "けい" },
          { "student_id": "user_yyy", "display_name": "大山勝子" }
        ]
      }
    ]
  }
}
```

**UI処理フロー**

1. 画像からEXIF撮影日を抽出して `YYYY-MM-DD` を得る
2. `index.dates[ymd]` を参照
3. 候補UIを表示：
   - groups が 0件：「候補なし」＋ 手動入力（全生徒検索）
   - groups が 1件：その `participants` を候補表示（現状はこのケースのみ）
   - groups が 複数件：まず教室/会場を選ばせ、その `participants` を候補表示

**データ範囲**

- 過去730日〜未来60日のみ含まれる
- 範囲外の日付は「候補なし」へフォールバック

**エラー時**

- 取得失敗：「候補取得に失敗」＋ リトライボタン ＋ 手動入力へフォールバック
- 403/401：「認証が必要」表示（UI自体を Access 配下にするなら通常起きにくい）

### 全生徒名簿（フォールバック用）

参加者候補にない生徒を選択する場合のフォールバック用データ。

**選択肢**

1. **students_index.json**（推奨）：`participants_index.json` と同様に事前生成してR2配置。UI起動時にfetch。
2. **Notion API 直接**：Worker経由でNotion生徒DBを検索。リアルタイム性は高いが遅延あり。

v1.3では選択肢1を推奨。JSON構造は以下を想定：

```json
{
  "generated_at": "2026-02-04T12:34:56+09:00",
  "students": [
    { "student_id": "user_xxx", "display_name": "けい" },
    { "student_id": "user_yyy", "display_name": "大山勝子" }
  ]
}
```

### ギャラリー更新API（Worker）

既存の★API Worker に追加するエンドポイント。

- `POST /admin/trigger-gallery-update`：GitHub Actions の `gallery-export.yml` をトリガー
- 認証：原則 Cloudflare Access のパス保護（フロントから固定鍵は送らない）
- 詳細は「4) ギャラリー更新トリガー」セクション参照

---

## 受け入れ条件（v1.4.1）

### 基本機能（v1.2継続）

- 整備モードで、未整備作品（`整備済=false`）を画像プレビュー付きで順に処理できる。
- 整備モードで、作者候補（当日参加者）が提示され選択できる。
- 整備モードで、タグ入力が高速で、子→親の自動付与、親→子のサジェスト、merged統合が正しく働く。
- タグ一括再計算で、既存作品に対して「親タグ追加＋merged置換」をdry-run→applyで反映できる。

### v1.3追加

- アップロード/整備モードで、`participants_index.json` から撮影日の参加者候補を取得・表示できる。
- 参加者候補がない場合、全生徒名簿からフォールバック検索できる。
- 整備モードで、複数画像がある作品の全画像を確認できる（サムネイルストリップ＋スワイプ）。
- 画像セット操作で、1作品の画像を分割して複数作品にできる。
- 画像セット操作で、複数作品の画像を1作品に統合できる。
- 画像セット操作で、画像を別の作品に移動できる。
- ギャラリー更新ボタンで、公開ギャラリーの即時更新をトリガーできる。
- タグ検索でひらがな⇔カタカナが同一視される。
- タグインデックスの鮮度警告が表示される。
- 新規登録時のR2/Notion部分成功に対応し、孤立ファイルの警告・再試行ができる。

### v1.4追加

- `classroom` の表記ゆらぎ（`東京` / `東京教室` など）があっても、Notion の `教室` には正規値（`東京教室` など）のみが保存される。
- `venue` が Notion の `会場`（Select）候補に一致する場合は自動セットされ、候補外の場合は警告して手動選択に誘導される（DBに未知の値を混入させない）。
- 代表画像（表紙）は「画像配列の先頭」で一意に表現でき、並び替えが公開ギャラリーのサムネ（`thumb` / fallback `images[0]`）に反映される。
- 画像統合では統合元ページは既定でアーカイブされ、★カウントのキー（Notion page id）を温存できる。
- 管理APIは Cloudflare Access のパス保護を前提とし、フロントに固定の管理鍵を埋め込まない（必要なら Worker 側で Access JWT を検証）。

---

## 変更履歴

変更履歴は以下へ分離しています。

- `docs/CHANGELOG.md`

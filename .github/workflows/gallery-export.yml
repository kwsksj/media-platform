name: Daily Gallery Export

on:
  schedule:
    # Runs at 07:10 UTC every day (16:10 JST)
    - cron: "10 7 * * *"
  workflow_dispatch:
    inputs:
      no_thumbs:
        description: "Skip thumbnail generation"
        required: false
        type: boolean
        default: false
      thumb_width:
        description: "Thumbnail width in px (default: 600)"
        required: false
        type: string
        default: "600"

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Export gallery.json
        env:
          # Notion
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          TAGS_DATABASE_ID: ${{ secrets.TAGS_DATABASE_ID }}

          # R2 Storage
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          CMD="auto-post export-gallery-json"

          if [ "${{ github.event.inputs.no_thumbs }}" = "true" ]; then
            CMD="$CMD --no-thumbs"
          fi

          if [ -n "${{ github.event.inputs.thumb_width }}" ]; then
            CMD="$CMD --thumb-width ${{ github.event.inputs.thumb_width }}"
          fi

          echo "Running: $CMD"
          $CMD

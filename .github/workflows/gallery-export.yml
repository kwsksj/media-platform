name: Daily Gallery Export

on:
  schedule:
    # Runs at 07:10 UTC every day (16:10 JST)
    - cron: "10 7 * * *"
  workflow_dispatch:
    inputs:
      no_thumbs:
        description: "Skip thumbnail generation"
        required: false
        type: boolean
        default: false
      no_light:
        description: "Skip light image generation"
        required: false
        type: boolean
        default: false
      overwrite_thumbs:
        description: "Overwrite existing thumbnails"
        required: false
        type: boolean
        default: false
      overwrite_light:
        description: "Overwrite existing light images"
        required: false
        type: boolean
        default: false
      thumb_width:
        description: "Thumbnail width in px (default: 600)"
        required: false
        type: string
        default: "600"
      light_max_size:
        description: "Max size for light images in px (default: 1600)"
        required: false
        type: string
        default: "1600"
      light_quality:
        description: "JPEG quality for light images (default: 75)"
        required: false
        type: string
        default: "75"

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Export gallery.json
        env:
          # Notion
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          TAGS_DATABASE_ID: ${{ secrets.TAGS_DATABASE_ID }}

          # Instagram (export-gallery-json では不要だが、環境依存のエラー回避用に設定)
          INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
          INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_BUSINESS_ACCOUNT_ID: ${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}

          # R2 Storage
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          CMD="auto-post export-gallery-json"

          if [ "${{ github.event.inputs.no_thumbs }}" = "true" ]; then
            CMD="$CMD --no-thumbs"
          fi

          if [ "${{ github.event.inputs.no_light }}" = "true" ]; then
            CMD="$CMD --no-light"
          fi

          if [ "${{ github.event.inputs.overwrite_thumbs }}" = "true" ]; then
            CMD="$CMD --overwrite-thumbs"
          fi

          if [ "${{ github.event.inputs.overwrite_light }}" = "true" ]; then
            CMD="$CMD --overwrite-light"
          fi

          if [ -n "${{ github.event.inputs.thumb_width }}" ]; then
            CMD="$CMD --thumb-width ${{ github.event.inputs.thumb_width }}"
          fi

          if [ -n "${{ github.event.inputs.light_max_size }}" ]; then
            CMD="$CMD --light-max-size ${{ github.event.inputs.light_max_size }}"
          fi

          if [ -n "${{ github.event.inputs.light_quality }}" ]; then
            CMD="$CMD --light-quality ${{ github.event.inputs.light_quality }}"
          fi

          echo "Running: $CMD"
          $CMD

      - name: Notify students after gallery update
        env:
          AUTO_NOTIFY_AFTER_GALLERY_UPDATE: ${{ vars.AUTO_NOTIFY_AFTER_GALLERY_UPDATE }}
          WORKER_ADMIN_BASE_URL: ${{ secrets.WORKER_ADMIN_BASE_URL }}
          WORKER_ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
        run: |
          AUTO_NOTIFY="$(echo "${AUTO_NOTIFY_AFTER_GALLERY_UPDATE:-}" | tr '[:upper:]' '[:lower:]')"
          if [ "$AUTO_NOTIFY" != "true" ]; then
            echo "Skip notification: auto notify disabled (set repository variable AUTO_NOTIFY_AFTER_GALLERY_UPDATE=true to enable)"
            exit 0
          fi

          if [ -z "$WORKER_ADMIN_BASE_URL" ] || [ -z "$WORKER_ADMIN_API_TOKEN" ]; then
            echo "Skip notification: WORKER_ADMIN_BASE_URL or ADMIN_API_TOKEN is not set"
            exit 0
          fi

          URL="${WORKER_ADMIN_BASE_URL%/}/admin/notify/students-after-gallery-update"
          echo "POST $URL"
          curl -sS -f -X POST "$URL" \
            -H "Authorization: Bearer $WORKER_ADMIN_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' || echo "Warning: failed to trigger post-gallery notifications"

name: Monthly Schedule Post

on:
  schedule:
    # Runs at 07:13 UTC on the 25th every month (16:13 JST)
    - cron: "13 7 25 * *"
  workflow_dispatch:
    inputs:
      year:
        description: "Target year (optional, e.g. 2026)"
        required: false
        type: string
      month:
        description: "Target month 1-12 (optional)"
        required: false
        type: string
      target:
        description: "When year/month omitted"
        required: false
        type: choice
        options:
          - next
          - current
        default: next
      platform:
        description: "Platform to post to"
        required: false
        type: choice
        options:
          - all
          - instagram
          - threads
          - x
        default: all
      dry_run:
        description: "Dry run (generate only, no posting)"
        required: false
        type: boolean
        default: false

jobs:
  monthly_schedule:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install schedule fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-zen-kaku-gothic-new fonts-courier-prime || true
          sudo mkdir -p /usr/local/share/fonts/monthly-schedule
          if [ ! -f /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Regular.ttf ]; then
            sudo curl -fsSL https://raw.githubusercontent.com/google/fonts/main/ofl/zenkakugothicnew/ZenKakuGothicNew-Regular.ttf -o /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Regular.ttf
          fi
          if [ ! -f /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Bold.ttf ]; then
            sudo curl -fsSL https://raw.githubusercontent.com/google/fonts/main/ofl/zenkakugothicnew/ZenKakuGothicNew-Bold.ttf -o /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Bold.ttf
          fi
          if [ ! -f /usr/local/share/fonts/monthly-schedule/CourierPrime-Regular.ttf ]; then
            sudo curl -fsSL https://raw.githubusercontent.com/google/fonts/main/ofl/courierprime/CourierPrime-Regular.ttf -o /usr/local/share/fonts/monthly-schedule/CourierPrime-Regular.ttf
          fi
          if [ ! -f /usr/local/share/fonts/monthly-schedule/CourierPrime-Bold.ttf ]; then
            sudo curl -fsSL https://raw.githubusercontent.com/google/fonts/main/ofl/courierprime/CourierPrime-Bold.ttf -o /usr/local/share/fonts/monthly-schedule/CourierPrime-Bold.ttf
          fi
          sudo fc-cache -f

      - name: Post Monthly Schedule
        env:
          # Notion
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          MONTHLY_SCHEDULE_SOURCE: ${{ vars.MONTHLY_SCHEDULE_SOURCE }}
          MONTHLY_SCHEDULE_JSON_KEY: ${{ vars.MONTHLY_SCHEDULE_JSON_KEY }}
          MONTHLY_SCHEDULE_JSON_URL: ${{ vars.MONTHLY_SCHEDULE_JSON_URL }}
          MONTHLY_SCHEDULE_NOTION_DATABASE_ID: ${{ vars.MONTHLY_SCHEDULE_NOTION_DATABASE_ID }}
          MONTHLY_SCHEDULE_DATE_PROP: ${{ vars.MONTHLY_SCHEDULE_DATE_PROP }}
          MONTHLY_SCHEDULE_TITLE_PROP: ${{ vars.MONTHLY_SCHEDULE_TITLE_PROP }}
          MONTHLY_SCHEDULE_CLASSROOM_PROP: ${{ vars.MONTHLY_SCHEDULE_CLASSROOM_PROP }}
          MONTHLY_SCHEDULE_VENUE_PROP: ${{ vars.MONTHLY_SCHEDULE_VENUE_PROP }}
          MONTHLY_SCHEDULE_TARGET: ${{ vars.MONTHLY_SCHEDULE_TARGET }}
          MONTHLY_SCHEDULE_SKIP_TARGET_MONTHS: ${{ vars.MONTHLY_SCHEDULE_SKIP_TARGET_MONTHS }}
          MONTHLY_SCHEDULE_CAPTION_TEMPLATE: ${{ vars.MONTHLY_SCHEDULE_CAPTION_TEMPLATE }}
          MONTHLY_SCHEDULE_FONT_JP_REGULAR_PATH: /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Regular.ttf
          MONTHLY_SCHEDULE_FONT_JP_BOLD_PATH: /usr/local/share/fonts/monthly-schedule/ZenKakuGothicNew-Bold.ttf
          MONTHLY_SCHEDULE_FONT_NUM_REGULAR_PATH: /usr/local/share/fonts/monthly-schedule/CourierPrime-Regular.ttf
          MONTHLY_SCHEDULE_FONT_NUM_BOLD_PATH: /usr/local/share/fonts/monthly-schedule/CourierPrime-Bold.ttf

          # Instagram
          INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
          INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_BUSINESS_ACCOUNT_ID: ${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}

          # Threads
          THREADS_APP_ID: ${{ secrets.THREADS_APP_ID }}
          THREADS_APP_SECRET: ${{ secrets.THREADS_APP_SECRET }}
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}

          # X (Twitter)
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}

          # R2 Storage
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}

        run: |
          CMD="auto-post post-monthly-schedule"

          if [ -n "${{ github.event.inputs.year }}" ]; then
            CMD="$CMD --year ${{ github.event.inputs.year }}"
          fi

          if [ -n "${{ github.event.inputs.month }}" ]; then
            CMD="$CMD --month ${{ github.event.inputs.month }}"
          fi

          if [ -n "${{ github.event.inputs.target }}" ]; then
            CMD="$CMD --target ${{ github.event.inputs.target }}"
          fi

          if [ -n "${{ github.event.inputs.platform }}" ]; then
            CMD="$CMD --platform ${{ github.event.inputs.platform }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          $CMD

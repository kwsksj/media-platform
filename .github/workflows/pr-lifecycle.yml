name: PR Lifecycle Automation

on:
  pull_request_review:
    types:
      - submitted
  pull_request:
    types:
      - closed

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-merge-on-approval:
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Enable auto-merge for approved PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTO_ENABLED: ${{ vars.PR_AUTO_MERGE_ENABLED }}
        run: |
          set -euo pipefail
          enabled="$(echo "${AUTO_ENABLED:-true}" | tr '[:upper:]' '[:lower:]' | xargs)"
          if [ "$enabled" = "false" ]; then
            echo "Skip: PR_AUTO_MERGE_ENABLED=false"
            exit 0
          fi

          gh pr merge "$PR_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --auto \
            --squash \
            --delete-branch || {
              echo "Auto-merge could not be enabled. Ensure 'Allow auto-merge' and branch protection are configured."
              exit 0
            }

  post-merge-automation:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Delete merged head branch (fallback)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ref = context.payload.pull_request.head.ref;
            if (!ref || ["main", "master"].includes(ref)) {
              core.info(`Skip branch delete: ${ref ?? "unknown ref"}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${ref}`,
              });
              core.info(`Deleted branch heads/${ref}`);
            } catch (error) {
              core.info(`Skip delete branch: ${error.message}`);
            }

      - name: Detect changed paths
        id: changed-paths
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changed = files.map((item) => item.filename);
            const workerChanged = changed.some(
              (path) =>
                path.startsWith("apps/worker-api/") ||
                path === ".github/workflows/worker-deploy.yml" ||
                path === ".github/workflows/pr-lifecycle.yml"
            );
            const galleryChanged = changed.some(
              (path) =>
                path.startsWith("apps/gallery-web/") ||
                path.startsWith("tools/gallery-build/") ||
                path === ".github/workflows/gallery-export.yml" ||
                path === ".github/workflows/pr-lifecycle.yml"
            );

            core.info(`Changed files: ${changed.length}`);
            core.info(`worker_changed=${workerChanged}`);
            core.info(`gallery_changed=${galleryChanged}`);
            core.setOutput("worker_changed", workerChanged ? "true" : "false");
            core.setOutput("gallery_changed", galleryChanged ? "true" : "false");

      - name: Trigger worker deploy workflow
        if: ${{ vars.AUTO_WORKER_DEPLOY_ON_MERGE == 'true' && steps.changed-paths.outputs.worker_changed == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "worker-deploy.yml",
              ref: "main",
            });
            core.info("Dispatched worker-deploy.yml")

      - name: Trigger gallery export workflow
        if: ${{ vars.AUTO_GALLERY_EXPORT_ON_MERGE == 'true' && steps.changed-paths.outputs.gallery_changed == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "gallery-export.yml",
              ref: "main",
            });
            core.info("Dispatched gallery-export.yml")
